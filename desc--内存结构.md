# 内存结构

> 虚拟机

本虚拟机将内存大致分为四个部分：
1. 代码段，存放代码（虚拟机指令及其操作数）
2. 数据段，只用于字符串、变量等数据。
3. 栈，处理函数调用的相关数据，如函数参数与局部变量等，以及计算过程中的中间变量。
4. 堆，不显式在虚拟机内部构建，使用的是C++的new返回的内存，如符号表中的符号。

本虚拟机是基于栈的结构，指令最多有一个操作数，相对于基于寄存器的结构，完成相同的功能
需要更多的指令，但是指令生成的方式更加简单。

在代码段中，指令的存放格式如下：

```
|    JNZ    | <-- JNZ指令
|    0x01   | <-- JNZ指令的操作数，指明跳转位置
|    IMM    | <-- IMM指令
|    3      | <-- IMM指令的操作数，指明立即数值为3
|    ...    |
|    ...    |
|    ADD    | <-- ADD指令，其两个操作数隐含在栈顶及寄存器ax中
```

虚拟机共有4个寄存器：ax，sp，bp，pc。ax其实是栈顶缓存，而sp寄存器所指的为次栈顶。
1. ax寄存器，为通用寄存器，存放一条指令执行后的结果。
2. sp寄存器，永远指向栈顶，入栈是向低地址增长。 
3. pc寄存器，指向代码段中将要执行指令或者指令的操作数的位置。
4. bp寄存器，基址指针，在函数调用时保存调用函数前sp的值，以及指明函数参数及局部变量的位置。
